{% extends 'devices/base.html' %}
{% load i18n %}

{% block title %}{% trans "Dashboard" %} - Repair Café{% endblock %}

{% block content %}
<div class="container">
    <h2 class="card-header">{% trans "Device Dashboard" %}</h2>

    {% if reminder_count > 0 %}
    <div class="alert alert-warning">
        <strong>⚠️ {{ reminder_count }}</strong> {% trans "device(s) need attention (in system > 7 days)." %}
        <a href="{% url 'reminders' %}">{% trans "View reminders" %}</a>
    </div>
    {% endif %}

    <!-- Search and Filter -->
    <div class="card">
        <form method="get" action="{% url 'dashboard' %}">
            <div class="search-bar">
                <input type="text" name="search" class="form-control" placeholder="{% trans 'Search by Device ID, Customer Name, Phone, Device Type...' %}" value="{{ search_query }}">
                <button type="submit" class="btn btn-primary">{% trans "Search" %}</button>
            </div>
        </form>

        <div class="filter-buttons">
            <a href="{% url 'dashboard' %}" class="filter-btn {% if not status_filter %}active{% endif %}">{% trans "All" %}</a>
            {% for value, label in status_choices %}
            <a href="?status={{ value }}" class="filter-btn {% if status_filter == value %}active{% endif %}">{{ label }}</a>
            {% endfor %}
        </div>

        {% if intakers %}
        <div style="padding: 15px 20px; border-top: 1px solid #e0e0e0;">
            <form method="get" action="{% url 'dashboard' %}" style="display: flex; align-items: center; gap: 10px;">
                <label for="intaker-filter" style="margin: 0; font-weight: 500;">{% trans "Filter by Intaker:" %}</label>
                <select name="intaker" id="intaker-filter" class="form-control" style="max-width: 250px;" onchange="this.form.submit()">
                    <option value="">{% trans "All Intakers" %}</option>
                    {% for intaker in intakers %}
                    <option value="{{ intaker.id }}" {% if intaker_filter == intaker.id|stringformat:"s" %}selected{% endif %}>
                        {{ intaker.get_full_name|default:intaker.username }}
                    </option>
                    {% endfor %}
                </select>
                {% if status_filter %}
                <input type="hidden" name="status" value="{{ status_filter }}">
                {% endif %}
                {% if search_query %}
                <input type="hidden" name="search" value="{{ search_query }}">
                {% endif %}
                {% if sort_by %}
                <input type="hidden" name="sort" value="{{ sort_by }}">
                {% endif %}
            </form>
        </div>
        {% endif %}
    </div>

    <!-- Devices Table -->
    <div class="card">
        {% if devices %}
        <table class="table">
            <thead>
                <tr>
                    <th>
                        <a href="?sort={% if sort_by == 'device_id' %}-{% endif %}device_id{% if status_filter %}&status={{ status_filter }}{% endif %}{% if intaker_filter %}&intaker={{ intaker_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" style="color: inherit; text-decoration: none; display: block;">
                            {% trans "Device ID" %} {% if sort_by == 'device_id' %}↑{% elif sort_by == '-device_id' %}↓{% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?sort={% if sort_by == 'customer_name' %}-{% endif %}customer_name{% if status_filter %}&status={{ status_filter }}{% endif %}{% if intaker_filter %}&intaker={{ intaker_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" style="color: inherit; text-decoration: none; display: block;">
                            {% trans "Customer" %} {% if sort_by == 'customer_name' %}↑{% elif sort_by == '-customer_name' %}↓{% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?sort={% if sort_by == 'device_type' %}-{% endif %}device_type{% if status_filter %}&status={{ status_filter }}{% endif %}{% if intaker_filter %}&intaker={{ intaker_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" style="color: inherit; text-decoration: none; display: block;">
                            {% trans "Device" %} {% if sort_by == 'device_type' %}↑{% elif sort_by == '-device_type' %}↓{% endif %}
                        </a>
                    </th>
                    <th>{% trans "Problem" %}</th>
                    <th>
                        <a href="?sort={% if sort_by == 'status' %}-{% endif %}status{% if status_filter %}&status={{ status_filter }}{% endif %}{% if intaker_filter %}&intaker={{ intaker_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" style="color: inherit; text-decoration: none; display: block;">
                            {% trans "Status" %} {% if sort_by == 'status' %}↑{% elif sort_by == '-status' %}↓{% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?sort={% if sort_by == 'intake_datetime' %}-{% endif %}intake_datetime{% if status_filter %}&status={{ status_filter }}{% endif %}{% if intaker_filter %}&intaker={{ intaker_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" style="color: inherit; text-decoration: none; display: block;">
                            {% trans "Intake Date" %} {% if sort_by == 'intake_datetime' %}↑{% elif sort_by == '-intake_datetime' %}↓{% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?sort={% if sort_by == 'intaker__username' %}-{% endif %}intaker__username{% if status_filter %}&status={{ status_filter }}{% endif %}{% if intaker_filter %}&intaker={{ intaker_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}" style="color: inherit; text-decoration: none; display: block;">
                            {% trans "Intaker" %} {% if sort_by == 'intaker__username' %}↑{% elif sort_by == '-intaker__username' %}↓{% endif %}
                        </a>
                    </th>
                    <th>{% trans "Days" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for device in devices %}
                <tr>
                    <td><strong>{{ device.device_id }}</strong></td>
                    <td>
                        {{ device.customer_name }}<br>
                        <small>{{ device.phone_number }}</small>
                    </td>
                    <td>
                        {{ device.device_type }}<br>
                        <small>{{ device.brand_model }}</small>
                    </td>
                    <td>{{ device.problem_description|truncatewords:10 }}</td>
                    <td><span class="status-badge status-{{ device.status }}">{{ device.get_status_display }}</span></td>
                    <td>{{ device.intake_datetime|date:"Y-m-d H:i" }}</td>
                    <td>{{ device.intaker.get_full_name|default:device.intaker.username|default:"—" }}</td>
                    <td>{{ device.days_in_repair }}</td>
                    <td>
                        <a href="{% url 'device_detail' device.device_id %}" class="btn btn-secondary">{% trans "View" %}</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>{% trans "No devices found." %}</p>
        {% endif %}
    </div>
</div>
{% endblock %}
